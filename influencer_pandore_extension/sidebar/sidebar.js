console.log("sidebar.js charg√© avec succ√®s !");
// const BASE_URL = "https://influenceur-list.onrender.com";
// const FRONT_BASE_URL = "https://pandoreinfluencerfrontend.vercel.app";
const FRONT_BASE_URL = "http://localhost:3001";
const BASE_URL = "http://localhost:3000";

let tokenGlobal;
let userData;
let userId;

//-------------  UI SIDEBAR  -------------//

// Fermer le sidebar proprement
document.getElementById("close-sidebar-btn").addEventListener("click", () => {
  window.parent.postMessage("close-sidebar", "*");
});

// √âcouter les changements dans chrome.storage.sync
chrome.storage.onChanged.addListener((changes, area) => {
  if (area === "sync" && changes.auth_token) {
    console.log("Token modifi√©, rafra√Æchissement du sidebar...");
    refreshSidebar();
    fetchOtherSidebarData(tokenGlobal);
  }
});

// Rafra√Æchir tout le contenu du sidebar √† chaque ouverture
document.addEventListener("DOMContentLoaded", refreshSidebar);

function refreshSidebar() {
  console.log("Rafra√Æchissement du sidebar...");

  chrome.storage.sync.get(["auth_token", "userData"], (result) => {
    if (result.auth_token) {
      tokenGlobal = result.auth_token;
      userData = result.userData
      userId = userData.data.userId
      console.log("Token r√©cup√©r√© :", tokenGlobal);
      console.log("user data", userData)
      showMainContent();
      fetchAllSidebarData(tokenGlobal);
      fetchProfiles(userId, tokenGlobal);
      fetchScrappedProfiles(userId);
    } else {
      console.warn("Aucun token trouv√©, utilisateur d√©connect√©.");
      displayLoggedOutState();
      showWelcomeScreen();
    }
  });
}

// R√©cup√©rer toutes les donn√©es n√©cessaires au sidebar
function fetchAllSidebarData(token) {
  Promise.all([
    fetchUserData(token),
    fetchOtherSidebarData(token), // Ajoute ici d'autres appels API si n√©cessaire
  ])
    .then(() => console.log("Toutes les donn√©es ont √©t√© charg√©es."))
    .catch((error) =>
      console.error("Erreur lors du chargement des donn√©es :", error)
    );
}

// R√©cup√©ration des donn√©es utilisateur
async function fetchUserData(token) {
  try {
    const response = await fetch(`${BASE_URL}/auth/user`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      credentials: "include",
    });
    if (!response.ok)
      throw new Error(
        "Erreur lors de la r√©cup√©ration des donn√©es utilisateur."
      );
    const data = await response.json();
    chrome.storage.sync.set({ userData: data }, () => {
      console.log("Donn√©es utilisateur sauvegard√© dans l'extension.");
    });
    displayUserData(data);
  } catch (error) {
    showWelcomeScreen();
    return console.error("Erreur r√©cup√©ration utilisateur :", error);
  }
}

// Exemple : Autres donn√©es √† charger (remplace ou ajoute d'autres appels API)
async function fetchOtherSidebarData(token) {
  try {
    const response = await fetch(`${BASE_URL}/other-data`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    const data = await response.json();
    console.log("Autres donn√©es du sidebar :", data);
    displayOtherSidebarData(data);
  } catch (error) {
    return console.error("Erreur r√©cup√©ration autres donn√©es :", error);
  }
}

// Affichage des donn√©es utilisateur dans le sidebar
function displayUserData(user) {
  const userProfil = document.getElementById("auth");

  if (!userProfil) {
    console.error("‚ö†Ô∏è √âl√©ment #auth non trouv√© !");
    return;
  }

  userProfil.innerHTML = `
    <img id="profileImage" src="${user?.data.picture}" title="${user?.data.name}" 
         style="background-color: #9CA3AF; width: 25px; border-radius: 50%; cursor: pointer;" />
    <span style="font-weight: bold; color: white; text-transform: uppercase; font-size:10px">
      ${user?.data.name}
    </span>
    <!---<button id="logout-btn" style="
      background-color: red; color: white; border: none; 
      padding: 8px 12px; cursor: pointer; border-radius: 5px;
    ">D√©connexion</button>--->
  `;

  // document.getElementById("logout-btn").addEventListener("click", handleLogoutUser);
}

// Exemple : Affichage des autres donn√©es (personnalise selon tes besoins)
function displayOtherSidebarData(data) {
  const sidebarContent = document.getElementById("other-data");

  if (!sidebarContent) return;

  sidebarContent.innerHTML = `<p>Donn√©es suppl√©mentaires : ${JSON.stringify(
    data
  )}</p>`;
}

// Affichage de l'√©tat d√©connect√©
function displayLoggedOutState() {
  const loginBtn = document.getElementById("loginBtn");
  const createAccountBtn = document.getElementById("createAccountBtn");
  // if (userProfil) userProfil.innerHTML = `<p>üîí Utilisateur d√©connect√©.</p>`;
  if (loginBtn && createAccountBtn) {
    loginBtn.style.display = "inline";
    loginBtn.addEventListener("click", () => {
      chrome.tabs.create({ url: `${FRONT_BASE_URL}/login` });
    });
    createAccountBtn.addEventListener("click", () => {
      chrome.tabs.create({ url: `${FRONT_BASE_URL}/login` });
    });
  }
}

function showWelcomeScreen() {
  document.getElementById("welcome-screen").style.display = "block";
  document.getElementById("main-content").style.display = "none";
}

function showMainContent() {
  document.getElementById("welcome-screen").style.display = "none";
  document.getElementById("main-content").style.display = "block";
}

// // estion de la d√©connexion
// function handleLogoutUser() {
//   chrome.storage.sync.remove("auth_token", () => {
//     console.log("üö™ D√©connexion confirm√©e.");
//     displayLoggedOutState();
//     window.postMessage({ action: "logoutUser" }, "*");
//     location.reload();
//   });
// }

//-------------  GET SCRAPPED DATA  -------------//

// Bouton Scraper
document.getElementById("scrapeBtn").addEventListener("click", () => {
  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    const url = new URL(tabs[0].url);
    // D√©tecter la plateforme actuelle
    let scriptFile;
    if (url.hostname.includes("x.com")) {
      scriptFile = "./scripts/content_x.js";
    } else if (url.hostname.includes("instagram.com")) {
      scriptFile = "./scripts/content_instagram.js";
    } else if (url.hostname.includes("facebook.com")) {
      scriptFile = "./scripts/content_facebook.js";
    } else if (url.hostname.includes("linkedin.com")) {
      scriptFile = "./scripts/content_linkedin.js";
    } else if (url.hostname.includes("tiktok.com")) {
      scriptFile = "./scripts/content_tiktok.js";
    } else {
      const notSupportedMessage = document.getElementById(
        "notSupportedMessage"
      );
      notSupportedMessage.style.display = "block";
      document.getElementById("scrapeBtn").style.display = "none";
      const notSupportedMessageClose = document.getElementById(
        "notSupportedMessageClose"
      );
      notSupportedMessageClose.addEventListener("click", () => {
        notSupportedMessage.style.display = "none";
        document.getElementById("scrapeBtn").style.display = "flex";
        document.getElementById("scrapeBtn").textContent = "Obtenir";
        // window.location.reload();
      });
    }

    // Injecter et ex√©cuter le script correspondant
    chrome.scripting.executeScript({
      target: { tabId: tabs[0].id },
      files: [scriptFile],
    });
  });

  document.getElementById("scrapeBtn").textContent = "En cours...";
});

// √âcouter les messages envoy√©s par le content.js
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.success) {
    document.getElementById("dataGetSuccessMessage").style.display = "block";
    document.getElementById("scrapeBtn").style.display = "none";
    document
      .getElementById("dataGetSuccessMessageCLose")
      .addEventListener("click", () => {
        document.getElementById("dataGetSuccessMessage").style.display = "none";
        document.getElementById("scrapeBtn").style.display = "flex";
        document.getElementById("scrapeBtn").textContent = "Obtenir";
      });
  } else if (message.dataNotExtrated) {
    document.getElementById("dataGetErrorsMessage").style.display = "block";
    document.getElementById("scrapeBtn").style.display = "none";
    document
      .getElementById("dataGetErrorsMessage")
      .addEventListener("click", () => {
        document.getElementById("dataGetErrorsMessage").style.display = "none";
        document.getElementById("scrapeBtn").style.display = "flex";
        document.getElementById("scrapeBtn").textContent = "Obtenir";
      });
    // alert("Timeout reached, please reload the page and trying again");
    // window.location.href = window.location.href;
    // window.location.reload();
  } else if (message.networkError) {
    alert("Erreur de connection!");
  }
});

//-------------  GET PROFILE DATA BY USER CONNECTED  -------------//

async function fetchScrappedProfiles(userId) {
  try {
    const response = await fetch(`${BASE_URL}/platforms/all`);
    
    if (!response.ok) {
      throw new Error(`Erreur HTTP ! Statut : ${response.status}`);
    }

    const data = await response.json();

    // Filtrer les profils dont `userId` contient l'ID de l'utilisateur connect√©
    const filteredProfiles = data.filter(profile => profile.userId.includes(userId));

    console.log("Profils filtr√©s :", filteredProfiles);

  } catch (error) {
    console.error("Erreur lors de la r√©cup√©ration des listes :", error);
    listsLoader.style.display = "none";
  }
}

//-------------  GET LIST DATA  -------------//
let lists = [];
let filteredListData = [];

const listFilter = document.getElementById("listFilter");

// Fonction pour r√©cup√©rer les listes depuis l'API
async function fetchProfiles(userId, token) {
  try {
    const response = await fetch(`${BASE_URL}/lists/user/${userId}`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    });

    if (!response.ok) {
      throw new Error(`Erreur HTTP ! Statut : ${response.status}`);
    }

    const data = await response.json();
    console.log("Listes r√©cup√©r√©es :", data);

    // listsLoader.style.display = "none";
    lists = data;
    populateListFilter();
    // displayProfiles(lists.flatMap((list) => list.profiles));
  } catch (error) {
    console.error("Erreur lors de la r√©cup√©ration des listes :", error);
    listsLoader.style.display = "none";
  }
}

  // Fonction pour remplir le menu d√©roulant
  function populateListFilter() {
    console.log("Listes pour le filtre‚ÄØ:", lists);
    lists.forEach((list) => {
      const option = document.createElement("option");
      option.value = list._id;
      option.textContent = list.name;
      listFilter.appendChild(option);
    });
  }